<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Seller Dashboard - Sewakuy</title>

  <!-- BASE PATH UNTUK GITHUB PAGES -->
  <base href="https://nadifapermatasari.github.io/PlatformSewakuy/">

  <!-- BOOTSTRAP -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="style.css"/>

  <style>
    body { background:#F7F7FB }
    .card img { height:140px; object-fit:cover; background:#EEE }
  </style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-light bg-white shadow-sm">
  <div class="container">
    <span class="navbar-brand fw-bold">Seller Panel</span>
    <a href="index.html" class="btn btn-secondary">Kembali ke Home</a>
  </div>
</nav>

<!-- MAIN WRAPPER -->
<div class="container py-4">

  <h2 class="fw-bold mb-4">ðŸ“¦ Dashboard Seller</h2>

  <!-- TABS -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#itemsTab">Barang Terdaftar</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#historyTab">Riwayat Penyewaan</a></li>
  </ul>

  <div class="tab-content">

    <!-- LIST BARANG -->
    <div class="tab-pane fade show active" id="itemsTab">
      <div class="row g-3" id="sellerItemList"></div>
    </div>

    <!-- RIWAYAT SEWA -->
    <div class="tab-pane fade" id="historyTab">
      <div id="rentalHistoryList"></div>
    </div>

  </div>
</div>


<!-- =======================================
     JAVASCRIPT â€” SELLER PANEL LOGIC
=========================================== -->
<script>
// Helper placeholder (agar gambar tidak blank & tidak error)
const placeholderImg = "https://via.placeholder.com/300x200?text=No+Image";

// ==========================
// LOAD BARANG
// ==========================
function loadSellerItems() {
  const items = JSON.parse(localStorage.getItem("sellerItems") || "[]");
  const wrap = document.getElementById("sellerItemList");

  wrap.innerHTML = "";

  if (items.length === 0) {
    wrap.innerHTML = `<p class="text-center text-muted">Belum ada barang terdaftar.</p>`;
    return;
  }

  for (const it of items) {

    // FIX: pastikan gambar selalu valid
    const foto = (it.foto && it.foto[0]) ? it.foto[0] : placeholderImg;

    wrap.innerHTML += `
      <div class="col-md-4">
        <div class="card shadow-sm h-100 p-2">
          <img src="${foto}" class="card-img-top" alt="Foto Barang">
          <div class="card-body">
            <h5 class="fw-bold">${it.nama}</h5>
            <p><b>Kategori:</b> ${it.kategori}</p>
            <p><b>Harga:</b> Rp ${it.harga.toLocaleString()}</p>
            <p><b>Stok:</b> ${it.stok}</p>

            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-warning btn-sm" onclick="editItem('${it.id}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteItem('${it.id}')">Hapus</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }
}


// ==========================
// LOAD RIWAYAT PENYEWAAN
// ==========================
function loadRentHistory() {
  const rentals = JSON.parse(localStorage.getItem("rentalHistory") || "[]");
  const items = JSON.parse(localStorage.getItem("sellerItems") || "[]");

  const wrap = document.getElementById("rentalHistoryList");
  wrap.innerHTML = "";

  if (rentals.length === 0) {
    wrap.innerHTML = `<p class="text-center text-muted">Belum ada transaksi.</p>`;
    return;
  }

  for (const r of rentals) {
    const barang = items.find(i => i.id === r.itemId) || {};

    const foto = barang.foto?.[0] || placeholderImg;

    wrap.innerHTML += `
      <div class="card mb-3 shadow-sm p-3">
        <div class="row">
          <div class="col-md-3">
            <img src="${foto}" class="w-100 rounded" alt="Foto Barang">
          </div>

          <div class="col-md-9">
            <h5 class="fw-bold">${barang.nama || "Barang terhapus"}</h5>

            <p><b>Penyewa:</b> ${r.penyewa} (${r.nrp})</p>
            <p><b>Kontak:</b> ${r.kontak}</p>
            <p><b>Periode:</b> ${r.tglMulai || "-"} â†’ ${r.tglSelesai || "-"}</p>

            <p><b>Status:</b>
              <span class="badge ${r.status === "Dikembalikan" ? "bg-success" : "bg-warning text-dark"}">
                ${r.status}
              </span>
            </p>

            ${r.status === "Sedang Disewa"
              ? `<button class="btn btn-success btn-sm" onclick="returnItem('${r.rentId}')">Tandai Dikembalikan</button>`
              : ""}
          </div>
        </div>
      </div>
    `;
  }
}


// ==========================
// EDIT BARANG (PROMPT VERSION)
// ==========================
function editItem(id) {
  let items = JSON.parse(localStorage.getItem("sellerItems") || "[]");

  const idx = items.findIndex(i => i.id === id);
  if (idx === -1) return alert("Barang tidak ditemukan.");

  const it = items[idx];

  const newName  = prompt("Nama barang:", it.nama);
  if (!newName) return;

  const newHarga = prompt("Harga:", it.harga);
  const newStok  = prompt("Stok:", it.stok);

  it.nama  = newName;
  it.harga = Number(newHarga) || it.harga;
  it.stok  = Number(newStok)  || it.stok;

  items[idx] = it;
  localStorage.setItem("sellerItems", JSON.stringify(items));

  // Update ke categoryDB
  const categoryDB = JSON.parse(localStorage.getItem("categoryDB") || "{}");
  for (const cat in categoryDB) {
    categoryDB[cat] = categoryDB[cat].map(x => x.id === id ? it : x);
  }
  localStorage.setItem("categoryDB", JSON.stringify(categoryDB));

  loadSellerItems();
  loadRentHistory();
  alert("Perubahan telah disimpan.");
}


// ==========================
// HAPUS BARANG
// ==========================
function deleteItem(id) {
  if (!confirm("Hapus barang ini?")) return;

  // Hapus item utama
  let items = JSON.parse(localStorage.getItem("sellerItems") || "[]");
  items = items.filter(i => i.id !== id);
  localStorage.setItem("sellerItems", JSON.stringify(items));

  // Hapus dari kategori
  let categoryDB = JSON.parse(localStorage.getItem("categoryDB") || "{}");
  for (const cat in categoryDB) {
    categoryDB[cat] = categoryDB[cat].filter(i => i.id !== id);
  }
  localStorage.setItem("categoryDB", JSON.stringify(categoryDB));

  // Hapus transaksi terkait
  let rentals = JSON.parse(localStorage.getItem("rentalHistory") || "[]");
  rentals = rentals.filter(r => r.itemId !== id);
  localStorage.setItem("rentalHistory", JSON.stringify(rentals));

  loadSellerItems();
  loadRentHistory();

  alert("Barang dihapus beserta seluruh transaksi terkait.");
}


// ==========================
// RETURN ITEM
// ==========================
function returnItem(rentId) {
  let rentals = JSON.parse(localStorage.getItem("rentalHistory") || "[]");
  const idx = rentals.findIndex(r => r.rentId === rentId);
  if (idx === -1) return alert("Transaksi tidak ditemukan.");

  const rent = rentals[idx];

  if (rent.status !== "Sedang Disewa") return;

  rent.status = "Dikembalikan";
  rentals[idx] = rent;
  localStorage.setItem("rentalHistory", JSON.stringify(rentals));

  // restock item
  let items = JSON.parse(localStorage.getItem("sellerItems") || "[]");
  const itIdx = items.findIndex(i => i.id === rent.itemId);

  if (itIdx !== -1) {
    items[itIdx].stok += 1;
    localStorage.setItem("sellerItems", JSON.stringify(items));

    const categoryDB = JSON.parse(localStorage.getItem("categoryDB") || "{}");
    for (const cat in categoryDB) {
      categoryDB[cat] = categoryDB[cat].map(
        x => x.id === items[itIdx].id ? items[itIdx] : x
      );
    }
    localStorage.setItem("categoryDB", JSON.stringify(categoryDB));
  }

  loadSellerItems();
  loadRentHistory();

  alert("Barang ditandai sebagai dikembalikan.");
}


// ==========================
// INITIAL LOAD
// ==========================
loadSellerItems();
loadRentHistory();
</script>

<!-- BOOTSTRAP JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
