<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Seller Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .item-img {
            width: 100%;
            height: 140px;
            object-fit: cover;
            border-radius: 6px;
        }
    </style>
</head>

<body style="background:#f7f7f7;">


<!-- HEADER -->
<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand mb-0 h1">üì¶ Seller Dashboard</span>
    <a href="index.html" class="btn btn-outline-light">Kembali ke Home</a>
  </div>
</nav>


<div class="container py-4">

    <!-- ================= BARANG SELLER ================= -->
    <h3 class="fw-bold mb-3">üõí Barang Anda</h3>

    <div id="sellerItems" class="row g-3"></div>



    <hr class="my-5">


    <!-- ================= RIWAYAT RENTAL ================= -->
    <h3 class="fw-bold mb-3">üìÑ Riwayat Penyewaan</h3>

    <div id="rentalList"></div>

</div>



<!-- ======================= SCRIPT FINAL ======================= -->
<script>
/* ============================================================
   1. LOAD BARANG SELLER
============================================================ */
function loadSellerItems() {
    let categoryDB = JSON.parse(localStorage.getItem("categoryDB")) || {};

    const container = document.getElementById("sellerItems");
    container.innerHTML = "";

    let allItems = [];

    // gabungkan semua kategori menjadi satu list
    for (let cat in categoryDB) {
        allItems = allItems.concat(categoryDB[cat]);
    }

    if (allItems.length === 0) {
        container.innerHTML = "<p class='text-muted'>Belum ada barang yang ditambahkan.</p>";
        return;
    }

    allItems.forEach(item => {
        let div = document.createElement("div");
        div.className = "col-md-4";

        div.innerHTML = `
            <div class="card shadow-sm p-2 h-100">
                <img src="${item.foto[0]}" class="item-img mb-2">
                <h5 class="fw-bold">${item.nama}</h5>

                <p class="mb-1"><b>Kategori:</b> ${item.kategori}</p>
                <p class="mb-1"><b>Harga:</b> Rp ${item.harga.toLocaleString()}</p>
                <p class="mb-1"><b>Stok:</b> <span id="stok-${item.id}">${item.stok}</span></p>

                <p class="text-muted small mt-2">${item.deskripsi || ""}</p>
            </div>
        `;

        container.appendChild(div);
    });
}


/* ============================================================
   2. LOAD RIWAYAT RENTAL
============================================================ */
function loadRentalHistory() {
    const history = JSON.parse(localStorage.getItem("rentalHistory")) || [];
    const container = document.getElementById("rentalList");

    container.innerHTML = "";

    if (history.length === 0) {
        container.innerHTML = "<p class='text-muted'>Belum ada transaksi sewa.</p>";
        return;
    }

    history.forEach(rent => {
        let div = document.createElement("div");
        div.className = "card mb-3 shadow-sm";

        div.innerHTML = `
            <div class="card-body">
                <h5 class="fw-bold">üìå ${rent.itemNama}</h5>

                <p><b>Penyewa:</b> ${rent.penyewa} (${rent.nrp})</p>
                <p><b>Kontak:</b> ${rent.kontak}</p>
                <p><b>Tanggal Sewa:</b> ${rent.tglMulai} ‚ûù ${rent.tglSelesai}</p>

                <p><b>Status:</b> 
                    <span class="badge bg-${
                        rent.status === "Sedang Disewa" ? "warning text-dark" :
                        rent.status === "Selesai" ? "success" : "danger"
                    }">${rent.status}</span>
                </p>

                ${
                    rent.status === "Sedang Disewa"
                    ? `
                        <button class="btn btn-success btn-sm me-2"
                                onclick="updateStatus('${rent.rentId}', 'Selesai')">
                            Tandai Selesai
                        </button>
                        <button class="btn btn-danger btn-sm"
                                onclick="updateStatus('${rent.rentId}', 'Dibatalkan')">
                            Batalkan
                        </button>
                    `
                    : `<span class="text-muted small">Transaksi sudah selesai.</span>`
                }
            </div>
        `;

        container.appendChild(div);
    });
}



/* ============================================================
   3. UPDATE STATUS RENTAL + UPDATE STOK BARANG
============================================================ */
function updateStatus(rentId, newStatus) {

    let history = JSON.parse(localStorage.getItem("rentalHistory")) || [];
    let categoryDB = JSON.parse(localStorage.getItem("categoryDB")) || {};

    const rent = history.find(r => r.rentId === rentId);
    if (!rent) return alert("Transaksi tidak ditemukan.");

    const itemId = rent.itemId;

    // Cari barangnya di semua kategori
    let foundItem = null;
    let foundCategory = null;

    for (let cat in categoryDB) {
        let itemIndex = categoryDB[cat].findIndex(i => i.id === itemId);
        if (itemIndex !== -1) {
            foundItem = categoryDB[cat][itemIndex];
            foundCategory = cat;
            break;
        }
    }

    if (!foundItem) return alert("Barang tidak ditemukan!");

    // Jika item sedang disewa ‚Üí status selesai/batal ‚Üí stok kembali
    if (rent.status === "Sedang Disewa" && (newStatus === "Selesai" || newStatus === "Dibatalkan")) {
        foundItem.stok += 1;
    }

    // Update status rental
    rent.status = newStatus;

    // Save back
    localStorage.setItem("categoryDB", JSON.stringify(categoryDB));
    localStorage.setItem("rentalHistory", JSON.stringify(history));

    alert("Status berhasil diperbarui!");

    loadSellerItems();
    loadRentalHistory();
}



/* ============================================
   4. ON LOAD
============================================ */
loadSellerItems();
loadRentalHistory();
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
